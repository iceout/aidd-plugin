# P4.1 Stage Dispatch Checklist

目标：实现 `aidd_runtime/stage_dispatch.py`，统一 stage command 分发、legacy alias 归一化与状态切换。

## 子任务清单

- [x] **P4.1-a** 设计 dispatch 规格模型（`DispatchSpec/DispatchTarget/DispatchResult`）与 stage command 注册表。
- [x] **P4.1-b** 实现命令归一化与 legacy flow alias 映射（`/skill:*`、`/flow:*`、`/feature-dev-aidd:*`）。
- [x] **P4.1-c** 实现分发前状态切换：通过 `skills/aidd-flow-state/runtime/set_active_feature.py` 与 `set_active_stage.py` 更新 `.active.json`。
- [x] **P4.1-d** 实现 runtime 入口调用（含 `--ticket` 注入与显式错误处理）。
- [x] **P4.1-e** 新增测试：alias 解析、`tasks-new` 分发状态更新、active ticket 继承分发 `spec-interview`。
- [x] **P4.1-f** 接入后续 P4.2 profile 执行层（将 subprocess 执行策略下沉到 `command_runner.py`）。
- [x] **P4.1-g** 补充更多阶段集成回归（`idea-new/researcher/plan-new` 链路）。

## 当前实现范围

- 新增：`aidd_runtime/stage_dispatch.py`
- 新增：`aidd_runtime/command_runner.py`
- 新增：`tests/runtime/test_stage_dispatch.py`
- 新增：`tests/runtime/test_command_runner.py`
