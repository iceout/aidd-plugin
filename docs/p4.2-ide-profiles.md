# P4.2 IDE Profiles 策略说明

## 目标
- 仅收敛宿主协议差异（命令前缀、skills 目录、执行限制/环境）。
- stage 业务逻辑与工件契约保持单一实现，不按 IDE 分叉。

## Profile 选择顺序
`aidd_runtime.ide_profiles.select_profile()` 按以下优先级选择 profile：
1. 显式参数 `profile`（调用方直接指定）。
2. 命令前缀信号（当前仅 `$...` 识别为 `codex`）。
3. 环境变量信号（`AIDD_IDE_PROFILE`，其次 `AIDD_HOST`）。
4. skills 安装目录自动探测（仅当恰好识别到一个 profile 时采用）。
5. 默认值 `kimi`。

## Skills 目录发现链路
`aidd_runtime.ide_profiles.discover_skills_dirs()` 采用以下链路：
1. 若存在 `AIDD_SKILLS_DIRS`（`os.pathsep` 分隔）则优先使用该覆盖值。
2. 否则使用 profile 内置目录：
   - `kimi`: `~/.config/agents/skills`
   - `codex`: `~/.codex/skills`
   - `cursor`: `~/.cursor/skills`
3. 默认返回“存在的目录”；若都不存在则回退到 profile 配置目录（用于首次安装/引导）。

## 运行时注入环境变量
`aidd_runtime.command_runner.build_runtime_env()` 统一注入：
- `AIDD_ROOT`
- `AIDD_IDE_PROFILE`
- `AIDD_HOST`
- `AIDD_SKILLS_DIRS`
- `AIDD_PRIMARY_SKILLS_DIR`

以上变量由 `stage_dispatch` 与 runtime entrypoint 共用。
